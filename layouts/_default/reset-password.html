<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password — TuleKit</title>
  <style>
    :root {
      --bg: #0e1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #00c9b1;
      --accent-hover: #00e6cc;
      --red: #f85149;
      --green: #3fb950;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px 16px;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px 24px;
      margin-top: 40px;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input[type="password"] {
      width: 100%;
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type="password"]:focus {
      border-color: var(--accent);
    }
    .field + .field {
      margin-top: 16px;
    }
    .error-text {
      color: var(--red);
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 24px;
      transition: background 0.2s;
    }
    .btn-accent {
      background: var(--accent);
      color: #000;
    }
    .btn-accent:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top-color: #000;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* State screens */
    .state-screen {
      text-align: center;
      padding: 40px 0;
    }
    .state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }
    .state-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .state-message {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .loading-screen {
      text-align: center;
      padding: 60px 0;
    }
    .loading-screen .spinner {
      width: 32px;
      height: 32px;
      border-color: rgba(255,255,255,0.15);
      border-top-color: var(--accent);
    }
    .loading-screen p {
      color: var(--text-muted);
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- Loading -->
      <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <p>Verifying reset link…</p>
      </div>

      <!-- Error (invalid/expired link) -->
      <div id="error-state" class="state-screen" style="display:none;">
        <div class="state-icon">&#9888;&#65039;</div>
        <div class="state-title">Invalid or Expired Link</div>
        <p class="state-message">This password reset link is no longer valid. Please request a new one from the app.</p>
      </div>

      <!-- Reset form -->
      <div id="reset-form" style="display:none;">
        <h1>Set New Password</h1>
        <p class="subtitle">Enter your new password below.</p>

        <div class="field">
          <label for="new-password">New Password</label>
          <input type="password" id="new-password" autocomplete="new-password" placeholder="At least 6 characters">
        </div>

        <div class="field">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" autocomplete="new-password" placeholder="Re-enter password">
          <div id="match-error" class="error-text" style="display:none;">Passwords do not match.</div>
        </div>

        <div id="form-error" class="error-text" style="display:none;margin-top:16px;"></div>

        <button id="submit-btn" class="btn btn-accent" disabled>Update Password</button>
      </div>

      <!-- Success -->
      <div id="success-state" class="state-screen" style="display:none;">
        <div class="state-icon">&#9989;</div>
        <div class="state-title">Password Updated</div>
        <p class="state-message">Your password has been changed successfully. You can now sign in with your new password in the TuleKit app.</p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://htalnhgmjnghllyeugmo.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_4oKPyQW99OcoqRsLl1gvXA_AsZzgaXa';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $loading      = document.getElementById('loading');
    const $errorState   = document.getElementById('error-state');
    const $resetForm    = document.getElementById('reset-form');
    const $successState = document.getElementById('success-state');
    const $newPw        = document.getElementById('new-password');
    const $confirmPw    = document.getElementById('confirm-password');
    const $matchError   = document.getElementById('match-error');
    const $formError    = document.getElementById('form-error');
    const $submitBtn    = document.getElementById('submit-btn');

    function show(el) { el.style.display = ''; }
    function hide(el) { el.style.display = 'none'; }

    // Validate form state
    function validate() {
      const pw = $newPw.value;
      const confirm = $confirmPw.value;
      const mismatch = confirm.length > 0 && pw !== confirm;
      $matchError.style.display = mismatch ? '' : 'none';
      $submitBtn.disabled = pw.length < 6 || pw !== confirm;
    }

    $newPw.addEventListener('input', validate);
    $confirmPw.addEventListener('input', validate);

    // On page load, Supabase JS picks up the token from the URL fragment automatically
    // via onAuthStateChange. The reset link includes #access_token=...&type=recovery
    async function init() {
      // Listen for the PASSWORD_RECOVERY event
      const { data: { subscription } } = sb.auth.onAuthStateChange((event, session) => {
        if (event === 'PASSWORD_RECOVERY') {
          // Token is valid — show the reset form
          hide($loading);
          show($resetForm);
          $newPw.focus();
        }
      });

      // Also check if there's already a session from the URL hash
      const hash = window.location.hash;
      if (!hash || !hash.includes('access_token')) {
        // No token in URL — invalid link
        hide($loading);
        show($errorState);
        return;
      }

      // Give Supabase a moment to process the hash
      setTimeout(() => {
        // If still on loading screen after 5s, the token is probably invalid
        if ($loading.style.display !== 'none') {
          hide($loading);
          show($errorState);
        }
      }, 5000);
    }

    // Handle form submission
    $submitBtn.addEventListener('click', async () => {
      const pw = $newPw.value;
      $submitBtn.disabled = true;
      $submitBtn.innerHTML = '<span class="spinner"></span>';
      hide($formError);

      const { error } = await sb.auth.updateUser({ password: pw });

      if (error) {
        $formError.textContent = error.message;
        show($formError);
        $submitBtn.textContent = 'Update Password';
        validate();
        return;
      }

      hide($resetForm);
      show($successState);
    });

    init();
  </script>
</body>
</html>
