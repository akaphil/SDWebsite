{{ define "main" }}

<section class="section" style="padding-top: calc(80px + var(--space-xl));">
  <div class="container container--narrow">

    <nav class="breadcrumb" aria-label="Breadcrumb" style="justify-content: flex-start; margin-bottom: var(--space-lg);">
      <a href="/" style="color: var(--warm-gray);">Home</a>
      <span style="color: var(--stone-400);">/</span>
      <span style="color: var(--charcoal);">Quote</span>
    </nav>

    <!-- Loading -->
    <div id="state-loading" class="quote-state text-center" style="padding: var(--space-2xl) 0;">
      <div class="quote-spinner"></div>
      <p class="lead">Loading your quote&hellip;</p>
    </div>

    <!-- Error -->
    <div id="state-error" class="quote-state text-center hidden" style="padding: var(--space-2xl) 0;">
      <div class="quote-state-icon quote-state-icon--warning">&#9888;</div>
      <h2>Something went wrong</h2>
      <p id="error-message" class="lead"></p>
    </div>

    <!-- Already responded -->
    <div id="state-responded" class="quote-state text-center hidden" style="padding: var(--space-2xl) 0;">
      <div class="quote-state-icon" id="responded-icon"></div>
      <h2 id="responded-title"></h2>
      <p id="responded-message" class="lead"></p>
    </div>

    <!-- Success (after accepting/declining) -->
    <div id="state-success" class="quote-state text-center hidden" style="padding: var(--space-2xl) 0;">
      <div class="quote-state-icon" id="success-icon"></div>
      <h2 id="success-title"></h2>
      <p id="success-message" class="lead"></p>
    </div>

    <!-- Quote display -->
    <div id="state-quote" class="hidden">

      <h1 style="margin-bottom: var(--space-xs);">Your Quote</h1>
      <p id="quote-date" style="color: var(--warm-gray); font-size: 0.9rem; margin-bottom: var(--space-lg);"></p>

      <!-- Prepared for -->
      <div class="contact-form-card mb-lg">
        <h3>Prepared For</h3>
        <div class="quote-detail-grid">
          <div class="quote-detail-item">
            <div class="quote-condition-label">Name</div>
            <div id="lead-name"></div>
          </div>
          <div class="quote-detail-item">
            <div class="quote-condition-label">Email</div>
            <div id="lead-email"></div>
          </div>
        </div>
        <div style="margin-top: var(--space-md);">
          <div class="quote-condition-label">Description of Work</div>
          <p id="quote-description" style="white-space: pre-wrap; margin: var(--space-xs) 0 0;"></p>
        </div>
      </div>

      <!-- Conditions -->
      <div id="conditions-card" class="contact-form-card mb-lg hidden">
        <h3>Conditions</h3>
        <div id="conditions-list"></div>
      </div>

      <!-- Financials -->
      <div class="contact-form-card mb-lg">
        <h3>Pricing</h3>
        <div class="quote-financials">
          <div class="quote-fin-row">
            <span>Subtotal</span>
            <span id="quote-subtotal"></span>
          </div>
          <div class="quote-fin-row" id="vat-row">
            <span>VAT (20%)</span>
            <span id="quote-vat"></span>
          </div>
          <div class="quote-fin-row quote-fin-total">
            <span>Total</span>
            <span id="quote-total"></span>
          </div>
        </div>
        <a id="pdf-link" class="quote-pdf-link hidden" href="#" target="_blank" rel="noopener">
          &#128196; Download PDF Quote
        </a>
      </div>

      <!-- Acceptance form -->
      <div class="contact-form-card">
        <h3>Your Response</h3>
        <form id="acceptance-form" class="contact-form">
          <div class="form-group">
            <label for="accept-name">Your full name (to confirm acceptance)</label>
            <input type="text" id="accept-name" required placeholder="e.g. John Smith" autocomplete="name">
          </div>
          <label class="quote-checkbox-label">
            <input type="checkbox" id="accept-terms" required>
            <span>I have read and agree to the conditions above and wish to proceed with this quote</span>
          </label>
          <div class="quote-btn-group">
            <button type="submit" class="btn btn--primary btn--large" id="btn-accept" style="flex: 1;">Accept Quote</button>
            <button type="button" class="btn btn--secondary btn--large" id="btn-decline" style="flex: 1; color: var(--red, #c0392b); border-color: var(--red, #c0392b);">Decline</button>
          </div>
          <p id="form-status" class="hidden" style="text-align: center; margin-top: var(--space-sm); font-size: 0.9rem;"></p>
        </form>
      </div>

    </div>
  </div>
</section>

{{ end }}

{{ define "scripts" }}
<script>
  // ── Configuration ─────────────────────────────────────────────────────────
  const EDGE_FUNCTION_URL = 'https://htalnhgmjnghllyeugmo.supabase.co/functions/v1/quote-accept';

  // ── Elements ──────────────────────────────────────────────────────────────
  const $ = (id) => document.getElementById(id);

  const stateLoading   = $('state-loading');
  const stateError     = $('state-error');
  const stateResponded = $('state-responded');
  const stateSuccess   = $('state-success');
  const stateQuote     = $('state-quote');

  // ── Init ──────────────────────────────────────────────────────────────────
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');

  if (!token) {
    showError('No quote token found. Please check the link in your email.');
  } else {
    loadQuote(token);
  }

  // ── Load quote ────────────────────────────────────────────────────────────
  async function loadQuote(token) {
    try {
      const res = await fetch(EDGE_FUNCTION_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'fetch', token }),
      });

      const data = await res.json();

      if (res.status === 409) {
        showResponded(data.accepted);
        return;
      }
      if (res.status === 410) {
        showError(data.error || 'This link has expired.');
        return;
      }
      if (!res.ok) {
        showError(data.error || 'Unable to load quote.');
        return;
      }

      renderQuote(data);
    } catch (e) {
      showError('Network error. Please check your connection and try again.');
    }
  }

  // ── Render ────────────────────────────────────────────────────────────────
  function formatPence(pence) {
    return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' })
      .format(pence / 100);
  }

  function formatDate(isoString) {
    return new Date(isoString).toLocaleDateString('en-GB', {
      day: 'numeric', month: 'long', year: 'numeric',
    });
  }

  function renderQuote(data) {
    const { quote, lead } = data;

    // Quote info
    $('quote-date').textContent = 'Dated: ' + formatDate(quote.created_at);
    $('lead-name').textContent = lead.full_name;
    if (lead.email) {
      $('lead-email').textContent = lead.email;
    } else {
      $('lead-email').parentElement.classList.add('hidden');
    }
    $('quote-description').textContent = quote.description;

    // Conditions
    var conditions = [];
    if (quote.timescale) conditions.push({ label: 'Estimated Timescale', value: quote.timescale });
    if (quote.payment_terms) conditions.push({ label: 'Payment Terms', value: quote.payment_terms });
    if (quote.exclusions) conditions.push({ label: 'Exclusions', value: quote.exclusions });
    if (quote.conditions_notes) conditions.push({ label: 'Additional Notes', value: quote.conditions_notes });

    if (conditions.length > 0) {
      var list = $('conditions-list');
      conditions.forEach(function(c) {
        var item = document.createElement('div');
        item.className = 'quote-condition-item';
        item.innerHTML =
          '<div class="quote-condition-label">' + escapeHtml(c.label) + '</div>' +
          '<div>' + escapeHtml(c.value) + '</div>';
        list.appendChild(item);
      });
      $('conditions-card').classList.remove('hidden');
    }

    // Work dates
    if (quote.work_start_date || quote.work_end_date) {
      var dateStr = [quote.work_start_date, quote.work_end_date].filter(Boolean).join(' \u2013 ');
      var item = document.createElement('div');
      item.className = 'quote-condition-item';
      item.innerHTML =
        '<div class="quote-condition-label">Proposed Work Dates</div>' +
        '<div>' + escapeHtml(dateStr) + '</div>';
      $('conditions-list').appendChild(item);
      $('conditions-card').classList.remove('hidden');
    }

    // Financials
    $('quote-subtotal').textContent = formatPence(quote.subtotal_pence);
    if (quote.vat_pence > 0) {
      $('quote-vat').textContent = formatPence(quote.vat_pence);
    } else {
      $('vat-row').classList.add('hidden');
    }
    $('quote-total').textContent = formatPence(quote.total_pence);

    // PDF
    if (quote.pdf_url) {
      $('pdf-link').href = quote.pdf_url;
      $('pdf-link').classList.remove('hidden');
    }

    // Show quote
    stateLoading.classList.add('hidden');
    stateQuote.classList.remove('hidden');
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ── Form handlers ─────────────────────────────────────────────────────────
  $('acceptance-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    var name = $('accept-name').value.trim();
    if (!name) return;
    await respond('accept', name);
  });

  $('btn-decline').addEventListener('click', async function() {
    if (confirm('Are you sure you want to decline this quote?')) {
      await respond('decline');
    }
  });

  async function respond(action, name) {
    var statusEl = $('form-status');
    statusEl.textContent = 'Processing\u2026';
    statusEl.style.color = 'var(--warm-gray)';
    statusEl.classList.remove('hidden');

    $('btn-accept').disabled = true;
    $('btn-decline').disabled = true;

    try {
      var payload = { action: action, token: token };
      if (name) payload.name = name;

      var res = await fetch(EDGE_FUNCTION_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      var data = await res.json();

      if (!res.ok) {
        statusEl.textContent = data.error || 'Something went wrong. Please try again.';
        statusEl.style.color = '#c0392b';
        $('btn-accept').disabled = false;
        $('btn-decline').disabled = false;
        return;
      }

      showSuccess(action === 'accept');
    } catch (e) {
      statusEl.textContent = 'Network error. Please check your connection and try again.';
      statusEl.style.color = '#c0392b';
      $('btn-accept').disabled = false;
      $('btn-decline').disabled = false;
    }
  }

  // ── State transitions ─────────────────────────────────────────────────────
  function showError(msg) {
    stateLoading.classList.add('hidden');
    $('error-message').textContent = msg;
    stateError.classList.remove('hidden');
  }

  function showResponded(accepted) {
    stateLoading.classList.add('hidden');
    if (accepted) {
      $('responded-icon').innerHTML = '&#10003;';
      $('responded-icon').className = 'quote-state-icon quote-state-icon--success';
      $('responded-title').textContent = 'Quote Already Accepted';
      $('responded-message').textContent = 'This quote has already been accepted. No further action is needed.';
    } else {
      $('responded-icon').innerHTML = '&#10007;';
      $('responded-icon').className = 'quote-state-icon quote-state-icon--declined';
      $('responded-title').textContent = 'Quote Already Declined';
      $('responded-message').textContent = 'This quote has already been declined.';
    }
    stateResponded.classList.remove('hidden');
  }

  function showSuccess(accepted) {
    stateQuote.classList.add('hidden');
    if (accepted) {
      $('success-icon').innerHTML = '&#10003;';
      $('success-icon').className = 'quote-state-icon quote-state-icon--success';
      $('success-title').textContent = 'Quote Accepted!';
      $('success-message').textContent = 'Thank you \u2014 your acceptance has been recorded and we have been notified. We will be in touch shortly to arrange the work.';
    } else {
      $('success-icon').innerHTML = '&#10007;';
      $('success-icon').className = 'quote-state-icon quote-state-icon--declined';
      $('success-title').textContent = 'Quote Declined';
      $('success-message').textContent = 'The quote has been declined and we have been notified.';
    }
    stateSuccess.classList.remove('hidden');
  }
</script>
{{ end }}
